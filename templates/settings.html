<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - CertMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Prevent flash of white background in dark mode */
        @media (prefers-color-scheme: dark) {
            html {
                background-color: #111827 !important;
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'media', // Automatically respects system preference
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-700/50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-shield-alt text-primary text-2xl"></i>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">CertMate</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">SSL Certificate Manager</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-certificate mr-1"></i> Certificates
                    </a>
                    <a href="/settings" class="px-3 py-2 rounded-md text-sm font-medium text-primary bg-blue-50 dark:bg-blue-900/20 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-600 dark:border-blue-700">
                        <i class="fas fa-cog mr-1"></i> Settings
                    </a>
                    <a href="/help" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-question-circle mr-1"></i> Help
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
            <div class="px-6 py-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Settings</h2>
                <p class="text-gray-600 dark:text-gray-300 mt-1">Configure your DNS provider credentials and preferences</p>
                <div class="mt-3 flex items-center text-sm">
                    <div class="flex items-center text-green-600 dark:text-green-400" id="connectionStatus" style="display: none;">
                        <i class="fas fa-check-circle mr-1"></i>
                        <span>Connected and configured</span>
                    </div>
                    <div class="flex items-center text-yellow-600 dark:text-yellow-400" id="partialStatus" style="display: none;">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <span>Partially configured</span>
                    </div>
                    <div class="flex items-center text-red-600 dark:text-red-400" id="disconnectedStatus" style="display: none;">
                        <i class="fas fa-times-circle mr-1"></i>
                        <span>Not configured</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Form -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
            <div class="px-6 py-4 border-b dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Configuration</h3>
            </div>
            <div class="px-6 py-6">
                <form id="settingsForm" class="space-y-8">
                    
                    <!-- DNS Provider Selection -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3" id="dns-provider-label">
                            <i class="fas fa-server mr-1"></i>
                            DNS Provider
                        </label>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2" role="radiogroup" aria-labelledby="dns-provider-label">
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="cloudflare" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fab fa-cloudflare text-lg text-orange-500 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Cloudflare</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="cloudflare-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="route53" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fab fa-aws text-lg text-orange-400 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Route53</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="route53-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="digitalocean" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fab fa-digital-ocean text-lg text-blue-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">DigitalOcean</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="digitalocean-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="azure" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fab fa-microsoft text-lg text-blue-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Azure DNS</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="azure-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="google" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fab fa-google text-lg text-blue-500 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Google DNS</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="google-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="powerdns" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-server text-lg text-gray-600 dark:text-gray-400 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">PowerDNS</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="powerdns-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="rfc2136" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-exchange-alt text-lg text-gray-600 dark:text-gray-400 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">RFC2136</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="rfc2136-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="linode" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-cloud text-lg text-green-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Linode</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="linode-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="vultr" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-cloud text-lg text-blue-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Vultr</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="vultr-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="hetzner" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-server text-lg text-red-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Hetzner</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="hetzner-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="gandi" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-globe text-lg text-orange-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Gandi</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="gandi-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="ovh" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-server text-lg text-purple-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">OVH</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="ovh-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="namecheap" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-shopping-cart text-lg text-red-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Namecheap</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="namecheap-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="porkbun" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-paw text-lg text-pink-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Porkbun</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="porkbun-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="godaddy" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-globe text-lg text-green-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">GoDaddy</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="godaddy-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="dnsmadeeasy" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-cogs text-lg text-green-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">DNS Made Easy</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="dnsmadeeasy-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="nsone" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-network-wired text-lg text-indigo-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">NS1</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="nsone-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="he-ddns" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-bolt text-lg text-yellow-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Hurricane Electric</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="he-ddns-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="dns_provider" value="dynudns" class="sr-only peer">
                                <div class="p-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-blue-50 dark:bg-blue-900/20 dark:peer-checked:bg-blue-900/30 hover:border-gray-300 dark:hover:border-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-sync-alt text-lg text-purple-600 mb-1"></i>
                                        <div class="text-xs font-medium dark:text-white">Dynu</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="dynudns-status">Not configured</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- DNS Provider Configurations -->
                    <!-- Cloudflare Configuration -->
                    <div id="cloudflare-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fab fa-cloudflare mr-2 text-orange-500"></i>
                                Cloudflare Configuration
                            </h4>
                            <div>
                                <label for="cloudflare_api_token" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    API Token
                                </label>
                                <div class="mt-1">
                                    <input type="password" id="cloudflare_api_token" name="cloudflare_api_token" 
                                           class="block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Enter your Cloudflare API token">
                                </div>
                                <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                    Create an API token at <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" class="text-primary hover:underline">Cloudflare Dashboard</a> with <strong>Zone:DNS:Edit</strong> permissions.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- AWS Route53 Configuration -->
                    <div id="route53-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fab fa-aws mr-2 text-orange-400"></i>
                                AWS Route53 Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="route53_access_key_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Access Key ID
                                    </label>
                                    <input type="password" id="route53_access_key_id" name="route53_access_key_id" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="AKIAIOSFODNN7EXAMPLE">
                                </div>
                                <div>
                                    <label for="route53_secret_access_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Secret Access Key
                                    </label>
                                    <input type="password" id="route53_secret_access_key" name="route53_secret_access_key" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY">
                                </div>
                                <div>
                                    <label for="route53_region" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Region (Optional)
                                    </label>
                                    <input type="text" id="route53_region" name="route53_region" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="us-east-1" value="us-east-1">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Create IAM credentials with <strong>Route53FullAccess</strong> policy or a custom policy with Route53 DNS permissions.
                            </p>
                        </div>
                    </div>

                    <!-- Azure DNS Configuration -->
                    <div id="azure-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fab fa-microsoft mr-2 text-blue-600"></i>
                                Azure DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="azure_subscription_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Subscription ID
                                    </label>
                                    <input type="text" id="azure_subscription_id" name="azure_subscription_id" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="12345678-1234-1234-1234-123456789012">
                                </div>
                                <div>
                                    <label for="azure_resource_group" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Resource Group
                                    </label>
                                    <input type="text" id="azure_resource_group" name="azure_resource_group" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="my-dns-resource-group">
                                </div>
                                <div>
                                    <label for="azure_tenant_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Tenant ID
                                    </label>
                                    <input type="text" id="azure_tenant_id" name="azure_tenant_id" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="12345678-1234-1234-1234-123456789012">
                                </div>
                                <div>
                                    <label for="azure_client_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Client ID
                                    </label>
                                    <input type="text" id="azure_client_id" name="azure_client_id" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="12345678-1234-1234-1234-123456789012">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="azure_client_secret" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Client Secret
                                    </label>
                                    <input type="password" id="azure_client_secret" name="azure_client_secret" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your Azure client secret">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Create a Service Principal with <strong>DNS Zone Contributor</strong> role for your DNS zones.
                            </p>
                        </div>
                    </div>

                    <!-- Google Cloud DNS Configuration -->
                    <div id="google-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fab fa-google mr-2 text-blue-500"></i>
                                Google Cloud DNS Configuration
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="google_project_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Project ID
                                    </label>
                                    <input type="text" id="google_project_id" name="google_project_id" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="my-gcp-project-123456">
                                </div>
                                <div>
                                    <label for="google_service_account_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Service Account JSON Key
                                    </label>
                                    <textarea id="google_service_account_key" name="google_service_account_key" rows="4"
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder='{"type": "service_account", "project_id": "...", ...}'></textarea>
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Create a Service Account with <strong>DNS Administrator</strong> role and download the JSON key file.
                            </p>
                        </div>
                    </div>

                    <!-- PowerDNS Configuration -->
                    <div id="powerdns-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-server mr-2 text-gray-600"></i>
                                PowerDNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="powerdns_api_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API URL
                                    </label>
                                    <input type="url" id="powerdns_api_url" name="powerdns_api_url" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="https://powerdns.example.com:8081">
                                </div>
                                <div>
                                    <label for="powerdns_api_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API Key
                                    </label>
                                    <input type="password" id="powerdns_api_key" name="powerdns_api_key" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your PowerDNS API key">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Configure your PowerDNS server with API access enabled and provide the API endpoint and key.
                            </p>
                        </div>
                    </div>

                    <!-- DigitalOcean Configuration -->
                    <div id="digitalocean-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fab fa-digital-ocean mr-2 text-blue-600"></i>
                                DigitalOcean DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label for="digitalocean_api_token" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API Token
                                    </label>
                                    <input type="password" id="digitalocean_api_token" name="digitalocean_api_token" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your DigitalOcean API token">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Generate a personal access token from your DigitalOcean control panel with read/write permissions for DNS.
                            </p>
                        </div>
                    </div>

                    <!-- Linode Configuration -->
                    <div id="linode-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-cloud mr-2 text-green-600"></i>
                                Linode DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label for="linode_api_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API Key
                                    </label>
                                    <input type="password" id="linode_api_key" name="linode_api_key" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your Linode API key">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Create a personal access token from your Linode account with read/write access to DNS records.
                            </p>
                        </div>
                    </div>

                    <!-- Gandi Configuration -->
                    <div id="gandi-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-globe mr-2 text-orange-600"></i>
                                Gandi DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label for="gandi_api_token" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API Token
                                    </label>
                                    <input type="password" id="gandi_api_token" name="gandi_api_token" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your Gandi LiveDNS API token">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Generate a personal access token from your Gandi account with DNS access permissions.
                            </p>
                        </div>
                    </div>

                    <!-- OVH Configuration -->
                    <div id="ovh-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-server mr-2 text-purple-600"></i>
                                OVH DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="ovh_endpoint" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Endpoint
                                    </label>
                                    <select id="ovh_endpoint" name="ovh_endpoint" 
                                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary">
                                        <option value="">Select endpoint</option>
                                        <option value="ovh-eu">ovh-eu (Europe)</option>
                                        <option value="ovh-us">ovh-us (US)</option>
                                        <option value="ovh-ca">ovh-ca (Canada)</option>
                                        <option value="kimsufi-eu">kimsufi-eu</option>
                                        <option value="kimsufi-ca">kimsufi-ca</option>
                                        <option value="soyoustart-eu">soyoustart-eu</option>
                                        <option value="soyoustart-ca">soyoustart-ca</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="ovh_application_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Application Key
                                    </label>
                                    <input type="password" id="ovh_application_key" name="ovh_application_key" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your application key">
                                </div>
                                <div>
                                    <label for="ovh_application_secret" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Application Secret
                                    </label>
                                    <input type="password" id="ovh_application_secret" name="ovh_application_secret" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your application secret">
                                </div>
                                <div>
                                    <label for="ovh_consumer_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Consumer Key
                                    </label>
                                    <input type="password" id="ovh_consumer_key" name="ovh_consumer_key" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your consumer key">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Create an OVH application with DNS access permissions and configure the API credentials.
                            </p>
                        </div>
                    </div>

                    <!-- Namecheap Configuration -->
                    <div id="namecheap-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-shopping-cart mr-2 text-red-600"></i>
                                Namecheap DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="namecheap_username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Username
                                    </label>
                                    <input type="text" id="namecheap_username" name="namecheap_username" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your Namecheap username">
                                </div>
                                <div>
                                    <label for="namecheap_api_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API Key
                                    </label>
                                    <input type="password" id="namecheap_api_key" name="namecheap_api_key" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your Namecheap API key">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Enable API access in your Namecheap account and provide your username and API key.
                            </p>
                        </div>
                    </div>

                    <!-- RFC2136 Configuration -->
                    <div id="rfc2136-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-exchange-alt mr-2 text-gray-600"></i>
                                RFC2136 DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="rfc2136_nameserver" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Nameserver
                                    </label>
                                    <input type="text" id="rfc2136_nameserver" name="rfc2136_nameserver" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="ns.example.com">
                                </div>
                                <div>
                                    <label for="rfc2136_tsig_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        TSIG Key Name
                                    </label>
                                    <input type="text" id="rfc2136_tsig_key" name="rfc2136_tsig_key" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="mykey">
                                </div>
                                <div>
                                    <label for="rfc2136_tsig_secret" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        TSIG Secret
                                    </label>
                                    <input type="password" id="rfc2136_tsig_secret" name="rfc2136_tsig_secret" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Base64-encoded secret">
                                </div>
                                <div>
                                    <label for="rfc2136_tsig_algorithm" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        TSIG Algorithm (Optional)
                                    </label>
                                    <select id="rfc2136_tsig_algorithm" name="rfc2136_tsig_algorithm" 
                                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary">
                                        <option value="">Default (HMAC-MD5)</option>
                                        <option value="HMAC-MD5">HMAC-MD5</option>
                                        <option value="HMAC-SHA1">HMAC-SHA1</option>
                                        <option value="HMAC-SHA224">HMAC-SHA224</option>
                                        <option value="HMAC-SHA256">HMAC-SHA256</option>
                                        <option value="HMAC-SHA384">HMAC-SHA384</option>
                                        <option value="HMAC-SHA512">HMAC-SHA512</option>
                                    </select>
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Configure RFC2136 dynamic DNS updates for BIND or compatible DNS servers.
                            </p>
                        </div>
                    </div>

                    <!-- Additional Provider Configurations -->
                    
                    <!-- Hetzner Configuration -->
                    <div id="hetzner-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-server mr-2 text-red-600"></i>
                                Hetzner DNS Configuration
                            </h4>
                            <div>
                                <label for="hetzner_api_token" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    API Token
                                </label>
                                <input type="password" id="hetzner_api_token" name="hetzner_api_token" 
                                       class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                       placeholder="Your Hetzner DNS API token">
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Create an API token at <a href="https://dns.hetzner.com/" target="_blank" class="text-primary hover:underline">Hetzner DNS Console</a> with DNS zone permissions.
                            </p>
                        </div>
                    </div>

                    <!-- Porkbun Configuration -->
                    <div id="porkbun-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-paw mr-2 text-pink-600"></i>
                                Porkbun DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="porkbun_api_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API Key
                                    </label>
                                    <input type="password" id="porkbun_api_key" name="porkbun_api_key" 
                                           class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your Porkbun API key">
                                </div>
                                <div>
                                    <label for="porkbun_secret_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Secret Key
                                    </label>
                                    <input type="password" id="porkbun_secret_key" name="porkbun_secret_key" 
                                           class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your Porkbun secret key">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Get your API credentials from <a href="https://porkbun.com/account/api" target="_blank" class="text-primary hover:underline">Porkbun API page</a>.
                            </p>
                        </div>
                    </div>

                    <!-- GoDaddy Configuration -->
                    <div id="godaddy-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-globe mr-2 text-green-600"></i>
                                GoDaddy DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="godaddy_api_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API Key
                                    </label>
                                    <input type="password" id="godaddy_api_key" name="godaddy_api_key" 
                                           class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your GoDaddy API key">
                                </div>
                                <div>
                                    <label for="godaddy_secret" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API Secret
                                    </label>
                                    <input type="password" id="godaddy_secret" name="godaddy_secret" 
                                           class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your GoDaddy API secret">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Create API credentials at <a href="https://developer.godaddy.com/keys" target="_blank" class="text-primary hover:underline">GoDaddy Developer Portal</a>.
                            </p>
                        </div>
                    </div>

                    <!-- Hurricane Electric Configuration -->
                    <div id="he-ddns-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-bolt mr-2 text-yellow-600"></i>
                                Hurricane Electric DNS Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="he_ddns_username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Username
                                    </label>
                                    <input type="text" id="he_ddns_username" name="he_ddns_username" 
                                           class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your Hurricane Electric username">
                                </div>
                                <div>
                                    <label for="he_ddns_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Password
                                    </label>
                                    <input type="password" id="he_ddns_password" name="he_ddns_password" 
                                           class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your Hurricane Electric password">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Use your <a href="https://dns.he.net/" target="_blank" class="text-primary hover:underline">Hurricane Electric DNS</a> account credentials.
                            </p>
                        </div>
                    </div>

                    <!-- Dynu Configuration -->
                    <div id="dynudns-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-sync-alt mr-2 text-purple-600"></i>
                                Dynu DNS Configuration
                            </h4>
                            <div>
                                <label for="dynudns_token" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    API Token
                                </label>
                                <input type="password" id="dynudns_token" name="dynudns_token" 
                                       class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                       placeholder="Your Dynu API token">
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Generate an API token at <a href="https://www.dynu.com/en-US/ControlPanel/APICredentials" target="_blank" class="text-primary hover:underline">Dynu Control Panel</a>.
                            </p>
                        </div>
                    </div>

                    <!-- DNS Made Easy Configuration -->
                    <div id="dnsmadeeasy-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-cogs mr-2 text-green-600"></i>
                                DNS Made Easy Configuration
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="dnsmadeeasy_api_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        API Key
                                    </label>
                                    <input type="password" id="dnsmadeeasy_api_key" name="dnsmadeeasy_api_key" 
                                           class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your DNS Made Easy API key">
                                </div>
                                <div>
                                    <label for="dnsmadeeasy_secret_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Secret Key
                                    </label>
                                    <input type="password" id="dnsmadeeasy_secret_key" name="dnsmadeeasy_secret_key" 
                                           class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                           placeholder="Your DNS Made Easy secret key">
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Create API credentials in your DNS Made Easy account with DNS management permissions.
                            </p>
                        </div>
                    </div>

                    <!-- NS1 Configuration -->
                    <div id="nsone-config" class="dns-config hidden">
                        <div class="border border-orange-200 dark:border-orange-600 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-network-wired mr-2 text-indigo-600"></i>
                                NS1 DNS Configuration
                            </h4>
                            <div>
                                <label for="nsone_api_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    API Key
                                </label>
                                <input type="password" id="nsone_api_key" name="nsone_api_key" 
                                       class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                       placeholder="Your NS1 API key">
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                                Generate an API key in your NS1 account with DNS record management permissions.
                            </p>
                        </div>
                    </div>

                    <!-- Basic Settings -->
                    <div class="border-t pt-6">
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Basic Settings</h4>
                        
                        <!-- Email -->
                        <div class="mb-6">
                            <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                <i class="fas fa-envelope mr-1"></i>
                                Email Address
                            </label>
                            <div class="mt-1">
                                <input type="email" id="email" name="email" 
                                       class="block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                       placeholder="your@email.com" required>
                            </div>
                            <p class="mt-2 text-sm text-gray-500">
                                Used for Let's Encrypt registration and renewal notifications.
                            </p>
                        </div>

                        <!-- Domains -->
                        <div class="mb-6">
                            <label for="domains" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                <i class="fas fa-globe mr-1"></i>
                                Domains
                            </label>
                            <div class="mt-1">
                                <textarea id="domains" name="domains" rows="3"
                                       class="block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary"
                                       placeholder="example.com&#10;anotherdomain.com&#10;One domain per line"></textarea>
                            </div>
                            <p class="mt-2 text-sm text-gray-500">
                                Enter one domain per line. Certificates will be created for each domain with wildcard support (*.domain.com).
                            </p>
                        </div>

                        <!-- Auto Renewal -->
                        <div class="mb-6">
                            <div class="flex items-center">
                                <input type="checkbox" id="auto_renew" name="auto_renew" 
                                       class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                <label for="auto_renew" class="ml-2 block text-sm text-gray-900">
                                    Enable automatic certificate renewal
                                </label>
                            </div>
                            <p class="mt-2 text-sm text-gray-500 ml-6">
                                Certificates will be automatically renewed when they have 30 days or less until expiration.
                            </p>
                        </div>

                        <!-- API Bearer Token -->
                        <div class="mb-6">
                            <label for="api_bearer_token" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                <i class="fas fa-key mr-1"></i>
                                API Bearer Token
                            </label>
                            <div class="mt-1">
                                <input type="password" id="api_bearer_token" name="api_bearer_token" 
                                       class="appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                                       placeholder="Enter API bearer token for authentication">
                            </div>
                            <p class="mt-2 text-sm text-gray-500">
                                This token is required for API access and automated certificate downloads. Keep it secure!
                            </p>
                        </div>
                    </div>

                    <!-- Cache Configuration -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-6 rounded-lg">
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-database mr-2 text-blue-500"></i>
                            Deployment Status Cache
                        </h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="cache_ttl" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Cache TTL (Time to Live)
                                    </label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="number" id="cache_ttl" name="cache_ttl" min="30" max="3600" step="30"
                                               class="block w-full border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary focus:border-primary"
                                               placeholder="300">
                                        <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 text-gray-500 dark:text-gray-400 text-sm">
                                            seconds
                                        </span>
                                    </div>
                                    <p class="mt-1 text-xs text-gray-500">
                                        How long to cache deployment status results (30-3600 seconds)
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Cache Statistics
                                    </label>
                                    <div class="bg-white dark:bg-gray-700 p-3 rounded border border-gray-200 dark:border-gray-600 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 dark:text-gray-400">Cached Entries:</span>
                                            <span id="cache-entries" class="font-medium text-gray-900 dark:text-white">-</span>
                                        </div>
                                        <div class="flex justify-between mt-1">
                                            <span class="text-gray-600 dark:text-gray-400">Current TTL:</span>
                                            <span id="cache-current-ttl" class="font-medium text-gray-900 dark:text-white">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" onclick="refreshCacheStats()" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm">
                                    <i class="fas fa-sync-alt mr-1"></i>
                                    Refresh Stats
                                </button>
                                <button type="button" onclick="clearDeploymentCache()" 
                                        class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-colors text-sm">
                                    <i class="fas fa-trash mr-1"></i>
                                    Clear Cache
                                </button>
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-600 rounded-md p-3">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700">
                                            The deployment status cache stores SSL certificate check results to improve performance. 
                                            Lower TTL values provide more up-to-date status but may cause slower page loads.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end">
                        <button type="submit" id="saveBtn" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="mt-4 hidden"></div>
    </div>

    <script>
        // API Configuration
        const API_TOKEN = '{{ api_token }}';
        const API_HEADERS = {
            'Authorization': `Bearer ${API_TOKEN}`,
            'Content-Type': 'application/json'
        };

        // Global variables - properly initialized
        let currentSettings = {};
        let dnsProviders = {};
        let isLoading = false;

        // DOM Elements
        const form = document.getElementById('settingsForm');
        const saveBtn = document.getElementById('saveBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Validation functions
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validateDomain(domain) {
            const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            return domainRegex.test(domain) && domain.length <= 253;
        }

        function validateApiToken(token, provider) {
            if (!token || token.trim().length === 0) return false;
            
            // Provider-specific validation
            switch(provider) {
                case 'cloudflare':
                    return token.length >= 40; // Cloudflare tokens are typically 40 chars
                case 'route53':
                    return token.length >= 16; // AWS access keys
                case 'digitalocean':
                    return token.length >= 64; // DO tokens are 64 chars
                default:
                    return token.length >= 8; // Minimum length for any API token
            }
        }

        function validateForm() {
            const errors = [];
            
            // Validate email
            const email = document.getElementById('email').value;
            if (!email) {
                errors.push('Email address is required');
            } else if (!validateEmail(email)) {
                errors.push('Please enter a valid email address');
            }

            // Validate domains
            const domainsText = document.getElementById('domains').value;
            if (domainsText) {
                const domains = domainsText.split('\n').filter(d => d.trim());
                for (const domain of domains) {
                    if (!validateDomain(domain.trim())) {
                        errors.push(`Invalid domain format: ${domain}`);
                    }
                }
            }

            // Validate selected DNS provider configuration
            const selectedProvider = document.querySelector('input[name="dns_provider"]:checked');
            if (selectedProvider) {
                const provider = selectedProvider.value;
                const isConfigValid = validateProviderConfig(provider);
                if (!isConfigValid) {
                    errors.push(`Please configure ${provider} DNS provider settings`);
                }
            }

            return errors;
        }

        function validateProviderConfig(provider) {
            switch(provider) {
                case 'cloudflare':
                    const cfToken = document.getElementById('cloudflare_api_token').value;
                    return validateApiToken(cfToken, 'cloudflare');
                case 'route53':
                    const accessKey = document.getElementById('route53_access_key_id').value;
                    const secretKey = document.getElementById('route53_secret_access_key').value;
                    return accessKey && secretKey && accessKey.length >= 16 && secretKey.length >= 32;
                case 'azure':
                    const subId = document.getElementById('azure_subscription_id').value;
                    const resGroup = document.getElementById('azure_resource_group').value;
                    const tenantId = document.getElementById('azure_tenant_id').value;
                    const clientId = document.getElementById('azure_client_id').value;
                    const clientSecret = document.getElementById('azure_client_secret').value;
                    return subId && resGroup && tenantId && clientId && clientSecret;
                case 'google':
                    const projectId = document.getElementById('google_project_id').value;
                    const serviceKey = document.getElementById('google_service_account_key').value;
                    return projectId && serviceKey && isValidJSON(serviceKey);
                case 'digitalocean':
                    const doToken = document.getElementById('digitalocean_api_token').value;
                    return validateApiToken(doToken, 'digitalocean');
                case 'linode':
                    const linodeKey = document.getElementById('linode_api_key').value;
                    return validateApiToken(linodeKey, 'linode');
                case 'gandi':
                    const gandiToken = document.getElementById('gandi_api_token').value;
                    return validateApiToken(gandiToken, 'gandi');
                case 'ovh':
                    const ovhAppKey = document.getElementById('ovh_application_key').value;
                    const ovhAppSecret = document.getElementById('ovh_application_secret').value;
                    const ovhConsumerKey = document.getElementById('ovh_consumer_key').value;
                    return ovhAppKey && ovhAppSecret && ovhConsumerKey;
                case 'namecheap':
                    const namecheapUser = document.getElementById('namecheap_username').value;
                    const namecheapApiKey = document.getElementById('namecheap_api_key').value;
                    return namecheapUser && namecheapApiKey;
                case 'vultr':
                    const vultrKey = document.getElementById('vultr_api_key').value;
                    return validateApiToken(vultrKey, 'vultr');
                case 'nsone':
                    const nsoneKey = document.getElementById('nsone_api_key').value;
                    return validateApiToken(nsoneKey, 'nsone');
                case 'rfc2136':
                    const rfcNameserver = document.getElementById('rfc2136_nameserver').value;
                    const rfcTsigKey = document.getElementById('rfc2136_tsig_key').value;
                    const rfcTsigSecret = document.getElementById('rfc2136_tsig_secret').value;
                    return rfcNameserver && rfcTsigKey && rfcTsigSecret;
                case 'hetzner':
                    const hetznerToken = document.getElementById('hetzner_api_token').value;
                    return validateApiToken(hetznerToken, 'hetzner');
                case 'porkbun':
                    const porkbunApiKey = document.getElementById('porkbun_api_key').value;
                    const porkbunSecretKey = document.getElementById('porkbun_secret_key').value;
                    return porkbunApiKey && porkbunSecretKey;
                case 'godaddy':
                    const godaddyApiKey = document.getElementById('godaddy_api_key').value;
                    const godaddySecret = document.getElementById('godaddy_secret').value;
                    return godaddyApiKey && godaddySecret;
                case 'he-ddns':
                    const heUsername = document.getElementById('he_ddns_username').value;
                    const hePassword = document.getElementById('he_ddns_password').value;
                    return heUsername && hePassword;
                case 'dynudns':
                    const dynudnsToken = document.getElementById('dynudns_token').value;
                    return validateApiToken(dynudnsToken, 'dynudns');
                default:
                    return true; // Assume valid for providers without specific validation
            }
        }

        function isValidJSON(str) {
            try {
                JSON.parse(str);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Enhanced error handling
        function handleApiError(error, fallbackMessage = 'An error occurred') {
            console.error('API Error:', error);
            
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                return 'Network error: Please check your connection and try again';
            }
            
            if (error.message.includes('HTTP 401')) {
                return 'Authentication failed: Please check your API token';
            }
            
            if (error.message.includes('HTTP 403')) {
                return 'Permission denied: Insufficient privileges';
            }
            
            if (error.message.includes('HTTP 429')) {
                return 'Rate limit exceeded: Please wait and try again';
            }
            
            return error.message || fallbackMessage;
        }

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Prevent race conditions by loading sequentially
            initializeApp();
        });

        async function initializeApp() {
            try {
                isLoading = true;
                await loadSettings();
                await loadDNSProviders();
                setupEventListeners();
            } catch (error) {
                showMessage(handleApiError(error, 'Failed to initialize application'), 'error');
            } finally {
                isLoading = false;
            }
        }

        function setupEventListeners() {
            // DNS provider selection
            document.querySelectorAll('input[name="dns_provider"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    showDNSConfig(this.value);
                });
            });

            // Form submission with validation
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (isLoading) {
                    showMessage('Please wait for the current operation to complete', 'warning');
                    return;
                }

                const validationErrors = validateForm();
                if (validationErrors.length > 0) {
                    showMessage('Validation errors: ' + validationErrors.join(', '), 'error');
                    return;
                }

                saveSettings();
            });

            // Real-time validation for email
            const emailField = document.getElementById('email');
            if (emailField) {
                emailField.addEventListener('blur', function() {
                    if (this.value && !validateEmail(this.value)) {
                        this.classList.add('border-red-500');
                        this.title = 'Please enter a valid email address';
                    } else {
                        this.classList.remove('border-red-500');
                        this.title = '';
                    }
                });
            }

            // Real-time validation for domains
            const domainsField = document.getElementById('domains');
            if (domainsField) {
                domainsField.addEventListener('blur', function() {
                    const domains = this.value.split('\n').filter(d => d.trim());
                    let hasInvalid = false;
                    
                    for (const domain of domains) {
                        if (domain.trim() && !validateDomain(domain.trim())) {
                            hasInvalid = true;
                            break;
                        }
                    }
                    
                    if (hasInvalid) {
                        this.classList.add('border-red-500');
                        this.title = 'One or more domains have invalid format';
                    } else {
                        this.classList.remove('border-red-500');
                        this.title = '';
                    }
                });
            }

            // Global error handler
            window.addEventListener('error', function(e) {
                console.error('Global error caught:', e.error);
                showMessage('An unexpected error occurred. Please refresh the page.', 'error');
            });
        }

        function showDNSConfig(provider) {
            // Hide all DNS config sections
            document.querySelectorAll('.dns-config').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected provider config
            const configSection = document.getElementById(provider + '-config');
            if (configSection) {
                configSection.classList.remove('hidden');
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings', {
                    headers: API_HEADERS
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Settings loaded successfully:', data);
                currentSettings = data;
                populateForm(data);
                
            } catch (error) {
                const errorMessage = handleApiError(error, 'Failed to load settings');
                console.error('Error loading settings:', error);
                showMessage(errorMessage, 'error');
                
                // Try to populate form with empty data to prevent further errors
                populateForm({});
                throw error; // Re-throw to be caught by initializeApp
            }
        }

        async function loadDNSProviders() {
            try {
                const response = await fetch('/api/settings/dns-providers', {
                    headers: API_HEADERS
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                dnsProviders = data;
                updateProviderStatus(data);
                
            } catch (error) {
                const errorMessage = handleApiError(error, 'Failed to load DNS providers');
                console.error('Error loading DNS providers:', error);
                showMessage(errorMessage, 'warning');
            }
        }

        function updateProviderStatus(providersData) {
            const providers = providersData.available_providers || {};
            
            Object.keys(providers).forEach(provider => {
                const statusElement = document.getElementById(provider + '-status');
                if (statusElement) {
                    const configured = providers[provider].configured;
                    statusElement.textContent = configured ? 'Configured' : 'Not configured';
                    statusElement.className = configured ? 'text-xs text-green-600 mt-1' : 'text-xs text-gray-500 mt-1';
                }
            });
        }

        function populateForm(data) {
            // Add null/undefined check at the beginning
            if (!data) {
                console.warn('Settings data is null or undefined, using defaults');
                data = {};
            }

            // Basic settings
            document.getElementById('email').value = data.email || '';
            document.getElementById('domains').value = (data.domains || []).join('\n');
            document.getElementById('auto_renew').checked = data.auto_renew !== false;

            // DNS Provider
            const dnsProvider = data.dns_provider || 'cloudflare';
            const providerRadio = document.querySelector(`input[name="dns_provider"][value="${dnsProvider}"]`);
            if (providerRadio) {
                providerRadio.checked = true;
                showDNSConfig(dnsProvider);
            }

            // DNS Provider configurations - add safety checks
            const dnsProviders = data.dns_providers || {};
            
            // Cloudflare (backward compatibility)
            if (data.has_cloudflare_token || (dnsProviders.cloudflare && dnsProviders.cloudflare.api_token)) {
                const cloudflareField = document.getElementById('cloudflare_api_token');
                if (cloudflareField) {
                    cloudflareField.placeholder = 'Token configured (hidden)';
                }
            }

            // Populate DNS provider fields - add safety checks
            if (dnsProviders && typeof dnsProviders === 'object') {
                Object.keys(dnsProviders).forEach(provider => {
                    const config = dnsProviders[provider];
                    if (config && typeof config === 'object') {
                        Object.keys(config).forEach(key => {
                            const fieldId = provider + '_' + key;
                            const field = document.getElementById(fieldId);
                            if (field) {
                                if (config[key] === '***masked***') {
                                    field.placeholder = 'Value configured (hidden)';
                                } else if (config[key]) {
                                    field.value = config[key];
                                }
                            }
                        });
                    }
                });
            }

            // API Bearer Token
            if (data.has_api_bearer_token) {
                const tokenField = document.getElementById('api_bearer_token');
                if (tokenField) {
                    tokenField.placeholder = 'Token configured (hidden)';
                }
            }
            
            // Cache settings
            loadCacheSettings();
            
            // Update connection status
            updateConnectionStatus(data);
        }
        
        function updateConnectionStatus(data) {
            // Add null/undefined check
            if (!data) {
                console.warn('Connection status data is null or undefined');
                data = {};
            }

            const connectionStatus = document.getElementById('connectionStatus');
            const partialStatus = document.getElementById('partialStatus');
            const disconnectedStatus = document.getElementById('disconnectedStatus');
            
            // Hide all status indicators
            [connectionStatus, partialStatus, disconnectedStatus].forEach(el => {
                if (el) {
                    el.style.display = 'none';
                }
            });
            
            // Check configuration completeness with safe null checks
            const hasEmail = data.email && data.email.length > 0;
            const hasDomains = data.domains && Array.isArray(data.domains) && data.domains.length > 0;
            const hasApiToken = data.has_api_bearer_token;
            
            // Safe check for DNS provider configuration
            let hasDnsProvider = false;
            if (data.dns_provider && data.dns_providers && typeof data.dns_providers === 'object') {
                const providerConfig = data.dns_providers[data.dns_provider];
                if (providerConfig && typeof providerConfig === 'object') {
                    hasDnsProvider = Object.keys(providerConfig).length > 0;
                }
            }
            
            const completeness = [hasEmail, hasDomains, hasApiToken, hasDnsProvider].filter(Boolean).length;
            
            if (completeness === 4 && connectionStatus) {
                connectionStatus.style.display = 'flex';
            } else if (completeness > 0 && partialStatus) {
                partialStatus.style.display = 'flex';
            } else if (disconnectedStatus) {
                disconnectedStatus.style.display = 'flex';
            }
        }

        // Enhanced message display function
        function showMessage(message, type = 'success') {
            const messageDiv = document.getElementById('statusMessage');
            if (!messageDiv) return;

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const colors = {
                success: 'bg-green-100 border-green-400 text-green-700 dark:bg-green-900/20 dark:border-green-600 dark:text-green-400',
                error: 'bg-red-100 border-red-400 text-red-700 dark:bg-red-900/20 dark:border-red-600 dark:text-red-400',
                warning: 'bg-yellow-100 border-yellow-400 text-yellow-700 dark:bg-yellow-900/20 dark:border-yellow-600 dark:text-yellow-400',
                info: 'bg-blue-100 border-blue-400 text-blue-700 dark:bg-blue-900/20 dark:border-blue-600 dark:text-blue-400'
            };

            messageDiv.className = `mt-4 p-4 border rounded-md ${colors[type] || colors.info}`;
            messageDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                </div>
            `;
            messageDiv.classList.remove('hidden');

            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }

            // Add ARIA live region for screen readers
            messageDiv.setAttribute('role', 'alert');
            messageDiv.setAttribute('aria-live', 'polite');
        }

        // Enhanced save function with comprehensive error handling
        async function saveSettings() {
            if (isLoading) {
                showMessage('Save operation already in progress', 'warning');
                return;
            }

            try {
                isLoading = true;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

                // Validate form before sending
                const validationErrors = validateForm();
                if (validationErrors.length > 0) {
                    throw new Error('Validation failed: ' + validationErrors.join(', '));
                }

                // Collect form data
                const formData = new FormData(form);
                const settings = {
                    email: formData.get('email'),
                    domains: formData.get('domains').split('\n').filter(d => d.trim()),
                    auto_renew: formData.has('auto_renew'),
                    dns_provider: formData.get('dns_provider'),
                    dns_providers: {}
                };

                // Collect DNS provider configurations
                const providers = [
                    'cloudflare', 'route53', 'azure', 'google', 'powerdns', 'digitalocean',
                    'linode', 'gandi', 'ovh', 'namecheap', 'rfc2136', 'vultr', 'dnsmadeeasy', 
                    'nsone', 'hetzner', 'porkbun', 'godaddy', 'he-ddns', 'dynudns'
                ];

                providers.forEach(provider => {
                    settings.dns_providers[provider] = {};
                    
                    if (provider === 'cloudflare') {
                        const token = formData.get('cloudflare_api_token');
                        if (token) settings.dns_providers[provider].api_token = token;
                    } else if (provider === 'route53') {
                        const accessKey = formData.get('route53_access_key_id');
                        const secretKey = formData.get('route53_secret_access_key');
                        const region = formData.get('route53_region');
                        if (accessKey) settings.dns_providers[provider].access_key_id = accessKey;
                        if (secretKey) settings.dns_providers[provider].secret_access_key = secretKey;
                        if (region) settings.dns_providers[provider].region = region;
                    } else if (provider === 'azure') {
                        const fields = ['subscription_id', 'resource_group', 'tenant_id', 'client_id', 'client_secret'];
                        fields.forEach(field => {
                            const value = formData.get(`azure_${field}`);
                            if (value) settings.dns_providers[provider][field] = value;
                        });
                    } else if (provider === 'google') {
                        const projectId = formData.get('google_project_id');
                        const serviceKey = formData.get('google_service_account_key');
                        if (projectId) settings.dns_providers[provider].project_id = projectId;
                        if (serviceKey) settings.dns_providers[provider].service_account_key = serviceKey;
                    } else if (provider === 'powerdns') {
                        const apiUrl = formData.get('powerdns_api_url');
                        const apiKey = formData.get('powerdns_api_key');
                        if (apiUrl) settings.dns_providers[provider].api_url = apiUrl;
                        if (apiKey) settings.dns_providers[provider].api_key = apiKey;
                    } else if (provider === 'digitalocean') {
                        const token = formData.get('digitalocean_api_token');
                        if (token) settings.dns_providers[provider].api_token = token;
                    } else if (provider === 'linode') {
                        const key = formData.get('linode_api_key');
                        if (key) settings.dns_providers[provider].api_key = key;
                    } else if (provider === 'gandi') {
                        const token = formData.get('gandi_api_token');
                        if (token) settings.dns_providers[provider].api_token = token;
                    } else if (provider === 'ovh') {
                        const endpoint = formData.get('ovh_endpoint');
                        const appKey = formData.get('ovh_application_key');
                        const appSecret = formData.get('ovh_application_secret');
                        const consumerKey = formData.get('ovh_consumer_key');
                        if (endpoint) settings.dns_providers[provider].endpoint = endpoint;
                        if (appKey) settings.dns_providers[provider].application_key = appKey;
                        if (appSecret) settings.dns_providers[provider].application_secret = appSecret;
                        if (consumerKey) settings.dns_providers[provider].consumer_key = consumerKey;
                    } else if (provider === 'namecheap') {
                        const username = formData.get('namecheap_username');
                        const apiKey = formData.get('namecheap_api_key');
                        if (username) settings.dns_providers[provider].username = username;
                        if (apiKey) settings.dns_providers[provider].api_key = apiKey;
                    } else if (provider === 'rfc2136') {
                        const nameserver = formData.get('rfc2136_nameserver');
                        const tsigKey = formData.get('rfc2136_tsig_key');
                        const tsigSecret = formData.get('rfc2136_tsig_secret');
                        const tsigAlgorithm = formData.get('rfc2136_tsig_algorithm');
                        if (nameserver) settings.dns_providers[provider].nameserver = nameserver;
                        if (tsigKey) settings.dns_providers[provider].tsig_key = tsigKey;
                        if (tsigSecret) settings.dns_providers[provider].tsig_secret = tsigSecret;
                        if (tsigAlgorithm) settings.dns_providers[provider].tsig_algorithm = tsigAlgorithm;
                    } else if (provider === 'hetzner') {
                        const token = formData.get('hetzner_api_token');
                        if (token) settings.dns_providers[provider].api_token = token;
                    } else if (provider === 'porkbun') {
                        const apiKey = formData.get('porkbun_api_key');
                        const secretKey = formData.get('porkbun_secret_key');
                        if (apiKey) settings.dns_providers[provider].api_key = apiKey;
                        if (secretKey) settings.dns_providers[provider].secret_key = secretKey;
                    } else if (provider === 'godaddy') {
                        const apiKey = formData.get('godaddy_api_key');
                        const secret = formData.get('godaddy_secret');
                        if (apiKey) settings.dns_providers[provider].api_key = apiKey;
                        if (secret) settings.dns_providers[provider].secret = secret;
                    } else if (provider === 'he-ddns') {
                        const username = formData.get('he_ddns_username');
                        const password = formData.get('he_ddns_password');
                        if (username) settings.dns_providers[provider].username = username;
                        if (password) settings.dns_providers[provider].password = password;
                    } else if (provider === 'dynudns') {
                        const token = formData.get('dynudns_token');
                        if (token) settings.dns_providers[provider].token = token;
                    } else if (provider === 'dnsmadeeasy') {
                        const apiKey = formData.get('dnsmadeeasy_api_key');
                        const secretKey = formData.get('dnsmadeeasy_secret_key');
                        if (apiKey) settings.dns_providers[provider].api_key = apiKey;
                        if (secretKey) settings.dns_providers[provider].secret_key = secretKey;
                    } else if (provider === 'nsone') {
                        const key = formData.get('nsone_api_key');
                        if (key) settings.dns_providers[provider].api_key = key;
                    }
                });

                // API Bearer Token
                const apiToken = formData.get('api_bearer_token');
                if (apiToken) {
                    settings.api_bearer_token = apiToken;
                }

                // Save cache settings separately
                saveCacheSettings();

                // Backward compatibility for Cloudflare
                if (settings.dns_providers.cloudflare?.api_token) {
                    settings.cloudflare_token = settings.dns_providers.cloudflare.api_token;
                }

                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: API_HEADERS,
                    body: JSON.stringify(settings)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    showMessage('Settings saved successfully!', 'success');
                    currentSettings = settings; // Update cached settings
                    await loadDNSProviders(); // Refresh provider status
                } else {
                    throw new Error(data.message || 'Failed to save settings');
                }

            } catch (error) {
                const errorMessage = handleApiError(error, 'Failed to save settings');
                console.error('Error saving settings:', error);
                showMessage(errorMessage, 'error');
            } finally {
                isLoading = false;
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Settings';
            }
        }

        // Cache Management Functions
        function loadCacheSettings() {
            try {
                const savedSettings = localStorage.getItem('deployment-cache-settings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    const ttlSeconds = Math.round((settings.ttl || 300000) / 1000);
                    document.getElementById('cache_ttl').value = ttlSeconds;
                } else {
                    document.getElementById('cache_ttl').value = 300; // 5 minutes default
                }
                refreshCacheStats();
            } catch (error) {
                console.error('Error loading cache settings:', error);
                document.getElementById('cache_ttl').value = 300; // 5 minutes default
            }
        }

        function saveCacheSettings() {
            const ttlSeconds = parseInt(document.getElementById('cache_ttl').value) || 300;
            const ttlMs = ttlSeconds * 1000;
            
            try {
                // Save to localStorage (this will be picked up by the cache system on the main page)
                localStorage.setItem('deployment-cache-settings', JSON.stringify({ ttl: ttlMs }));
                
                // Also notify any open main pages to update their cache settings
                localStorage.setItem('cache-settings-updated', Date.now().toString());
                
                showMessage(`Cache TTL updated to ${ttlSeconds} seconds`, 'success');
                setTimeout(refreshCacheStats, 500);
            } catch (error) {
                console.error('Error saving cache settings:', error);
                showMessage('Error saving cache settings', 'error');
            }
        }

        function refreshCacheStats() {
            try {
                const savedSettings = localStorage.getItem('deployment-cache-settings');
                let ttlSeconds = 300; // default
                
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    ttlSeconds = Math.round((settings.ttl || 300000) / 1000);
                }
                
                // We can't directly access the cache from the settings page,
                // but we can show the configured TTL
                document.getElementById('cache-entries').textContent = 'N/A (main page only)';
                document.getElementById('cache-current-ttl').textContent = `${ttlSeconds}s`;
                
                // If there's a way to get cache stats from the main page via postMessage or similar,
                // we could implement that here. For now, we show what we can.
                
            } catch (error) {
                console.error('Error refreshing cache stats:', error);
                document.getElementById('cache-entries').textContent = 'Error';
                document.getElementById('cache-current-ttl').textContent = 'Error';
            }
        }

        function clearDeploymentCache() {
            if (confirm('Are you sure you want to clear the deployment status cache? This will force a refresh of all certificate deployment statuses.')) {
                try {
                    // Signal main page to clear cache
                    localStorage.setItem('clear-deployment-cache', Date.now().toString());
                    showMessage('Cache clear signal sent. Refresh the main page to see the effect.', 'info');
                    setTimeout(refreshCacheStats, 500);
                } catch (error) {
                    console.error('Error clearing cache:', error);
                    showMessage('Error clearing cache', 'error');
                }
            }
        }
    </script>
</body>
</html>
